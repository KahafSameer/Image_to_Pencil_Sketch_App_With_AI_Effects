<!-- crop_section.html -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">

<div class="mb-3" id="cropper-section" style="display:none;">
    <h5>✂️ Crop the Image</h5>
    <div class="row justify-content-center">
        <div class="col-md-8">
            <img id="image-to-crop" src="" alt="Image to crop" class="img-fluid">
        </div>
    </div>
    <button id="crop-image" class="btn btn-primary mt-3 w-100">Crop Image</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<script>
    let cropper;

    // Show cropper when "Crop" option selected
    document.addEventListener('DOMContentLoaded', () => {
        const effectSelector = document.querySelector('select[name="effect"]');
        const cropperSection = document.getElementById("cropper-section");
        const imageToCrop = document.getElementById("image-to-crop");
        const fileInput = document.querySelector('input[name="file"]');

        if (!effectSelector) return;

        effectSelector.addEventListener('change', function () {
            if (this.value === 'crop') {
                cropperSection.style.display = 'block';
            } else {
                cropperSection.style.display = 'none';
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            }
        });

        fileInput.addEventListener('change', function () {
            const file = this.files[0];
            if (file && effectSelector.value === 'crop') {
                const reader = new FileReader();
                reader.onload = function (e) {
                    imageToCrop.src = e.target.result;
                    cropperSection.style.display = 'block';
                    if (cropper) {
                        cropper.destroy();
                    }
                    cropper = new Cropper(imageToCrop, {
                        aspectRatio: NaN,
                        viewMode: 1,
                    });
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById("crop-image").addEventListener("click", function () {
            if (cropper) {
                const canvas = cropper.getCroppedCanvas();
                canvas.toBlob(function (blob) {
                    const file = new File([blob], "cropped.png", { type: "image/png" });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;
                    document.querySelector('form').submit();
                });
            }
        });
    });
</script>
